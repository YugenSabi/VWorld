<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>РџРµСЂРµРјРµС‰РµРЅРёРµ С‚РѕС‡РµРє</title>
</head>
<body>
    <div id="status">РћС‚РєР»СЋС‡РµРЅРѕ</div>
    <button id="connectBtn">РџРѕРґРєР»СЋС‡РёС‚СЊСЃСЏ</button>
    <button id="addPointBtn" disabled>Р”РѕР±Р°РІРёС‚СЊ С‚РѕС‡РєСѓ</button>
    <button id="disconnectBtn" disabled>РћС‚РєР»СЋС‡РёС‚СЊСЃСЏ</button>
    <div id="canvas" style="width: 800px; height: 600px; border: 1px solid black; position: relative;"></div>

    <script>
        let ws = null;
        let points = {};
        const canvas = document.getElementById('canvas');
        const statusDiv = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const addPointBtn = document.getElementById('addPointBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/points`;

        function updateStatus(connected) {
            if (connected) {
                statusDiv.textContent = 'РџРѕРґРєР»СЋС‡РµРЅРѕ';
                connectBtn.disabled = true;
                addPointBtn.disabled = false;
                disconnectBtn.disabled = false;
            } else {
                statusDiv.textContent = 'РћС‚РєР»СЋС‡РµРЅРѕ';
                connectBtn.disabled = false;
                addPointBtn.disabled = true;
                disconnectBtn.disabled = true;
            }
        }

        function connect() {
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket РїРѕРґРєР»СЋС‡РµРЅ');
                updateStatus(true);
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                
                if (message.type === 'points_update') {
                    updatePoints(message.points);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket РѕС€РёР±РєР°:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket РѕС‚РєР»СЋС‡РµРЅ');
                updateStatus(false);
                points = {};
                renderPoints();
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function addPoint() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const rect = canvas.getBoundingClientRect();
                ws.send(JSON.stringify({
                    type: 'add_point',
                    screen_width: rect.width,
                    screen_height: rect.height
                }));
            }
        }

        function updatePoints(pointsData) {
            points = {};
            pointsData.forEach(pointData => {
                points[pointData.id] = pointData;
            });
            renderPoints();
        }

        function renderPoints() {
            canvas.innerHTML = '';
            Object.values(points).forEach(point => {
                const pointElement = document.createElement('div');
                pointElement.id = point.id;
                pointElement.style.position = 'absolute';
                pointElement.style.width = '10px';
                pointElement.style.height = '10px';
                pointElement.style.backgroundColor = 'red';
                pointElement.style.left = `${point.x}px`;
                pointElement.style.top = `${point.y}px`;
                canvas.appendChild(pointElement);
            });
        }

        canvas.addEventListener('click', (e) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                let closestPoint = null;
                let minDistance = Infinity;

                Object.values(points).forEach(point => {
                    const dx = point.x - x;
                    const dy = point.y - y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < minDistance && distance < 50) { // 50px СЂР°РґРёСѓСЃ РІС‹Р±РѕСЂР°
                        minDistance = distance;
                        closestPoint = point;
                    }
                });

                if (closestPoint) {
                    ws.send(JSON.stringify({
                        type: 'move_point',
                        point_id: closestPoint.id,
                        x: x,
                        y: y
                    }));
                } else {
                    Object.values(points).forEach(point => {
                        ws.send(JSON.stringify({
                            type: 'move_point',
                            point_id: point.id,
                            x: x,
                            y: y
                        }));
                    });
                }
            }
        });

        connectBtn.addEventListener('click', connect);
        addPointBtn.addEventListener('click', addPoint);
        disconnectBtn.addEventListener('click', disconnect);

        window.addEventListener('load', () => {
            connect();
        });
    </script>
</body>
</html>
